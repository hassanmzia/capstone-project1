version: "3.9"

services:
  # ============ DATABASE ============
  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: neural-postgres
    ports:
      - "${POSTGRES_PORT:-5435}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-neural_interface}
      POSTGRES_USER: ${POSTGRES_USER:-neural_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-neural_admin} -d ${POSTGRES_DB:-neural_interface}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ MESSAGE BROKER ============
  redis:
    image: redis:7-alpine
    container_name: neural-redis
    ports:
      - "${REDIS_PORT:-6385}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ DJANGO BACKEND ============
  django:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: neural-django
    ports:
      - "8085:8085"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-neural_interface}
      - REDIS_URL=redis://redis:6379
      - DJANGO_SETTINGS_MODULE=config.settings.development
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      - OLLAMA_BASE_URL=http://host.docker.internal:12434
      - MCP_SERVER_PORT=8087
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - recording_data:/app/data
      - ./backend:/app
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput 2>/dev/null;
             daphne -b 0.0.0.0 -p 8085 config.asgi:application"
    restart: unless-stopped

  # ============ NODE.JS BFF ============
  bff:
    build:
      context: ./bff
      dockerfile: Dockerfile
    container_name: neural-bff
    ports:
      - "${BFF_PORT:-3026}:3026"
    environment:
      - DJANGO_API_URL=http://django:8085
      - REDIS_URL=redis://redis:6379
      - PORT=3026
      - HOST_IP=${HOST_IP:-172.168.1.95}
    depends_on:
      - django
      - redis
    restart: unless-stopped

  # ============ NGINX (SSL Reverse Proxy) ============
  nginx:
    image: nginx:alpine
    container_name: neural-nginx
    ports:
      - "${FRONTEND_PORT:-3025}:3025"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - bff
      - django
    restart: unless-stopped

  # ============ REACT FRONTEND ============
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-/api}
        - VITE_WS_URL=${VITE_WS_URL:-wss://demo.eminencetechsolutions.com:3025}
    container_name: neural-frontend
    expose:
      - "80"
    depends_on:
      - bff
    restart: unless-stopped

  # ============ DATA ACQUISITION AGENT ============
  agent-data-acquisition:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-acquisition
    ports:
      - "${AGENT_ACQUISITION_PORT:-8088}:8088"
    environment:
      - AGENT_NAME=data_acquisition
      - AGENT_PORT=8088
      - REDIS_URL=redis://redis:6379
      - MCP_SERVER_URL=http://django:8085/mcp
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-neural_interface}
    depends_on:
      - redis
      - django
    volumes:
      - recording_data:/app/data
    restart: unless-stopped

  # ============ SIGNAL PROCESSING AGENT ============
  agent-signal-processing:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-processing
    ports:
      - "${AGENT_PROCESSING_PORT:-8089}:8089"
    environment:
      - AGENT_NAME=signal_processing
      - AGENT_PORT=8089
      - REDIS_URL=redis://redis:6379
      - MCP_SERVER_URL=http://django:8085/mcp
    depends_on:
      - redis
      - django
    restart: unless-stopped

  # ============ HARDWARE CONTROL AGENT ============
  agent-hardware-control:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-hardware
    ports:
      - "${AGENT_HARDWARE_PORT:-8090}:8090"
    environment:
      - AGENT_NAME=hardware_control
      - AGENT_PORT=8090
      - REDIS_URL=redis://redis:6379
      - MCP_SERVER_URL=http://django:8085/mcp
    depends_on:
      - redis
      - django
    restart: unless-stopped

  # ============ STORAGE AGENT ============
  agent-storage:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-storage
    ports:
      - "${AGENT_STORAGE_PORT:-8091}:8091"
    environment:
      - AGENT_NAME=storage
      - AGENT_PORT=8091
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-neural_interface}
      - MCP_SERVER_URL=http://django:8085/mcp
    depends_on:
      - redis
      - django
      - postgres
    volumes:
      - recording_data:/app/data
    restart: unless-stopped

  # ============ AI/ML AGENT ============
  agent-ai-ml:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-aiml
    ports:
      - "${AGENT_AIML_PORT:-8092}:8092"
    environment:
      - AGENT_NAME=ai_ml
      - AGENT_PORT=8092
      - REDIS_URL=redis://redis:6379
      - MCP_SERVER_URL=http://django:8085/mcp
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-neural_interface}
    depends_on:
      - redis
      - django
    restart: unless-stopped

  # ============ NOTIFICATION AGENT ============
  agent-notification:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-notification
    ports:
      - "${AGENT_NOTIFICATION_PORT:-8093}:8093"
    environment:
      - AGENT_NAME=notification
      - AGENT_PORT=8093
      - REDIS_URL=redis://redis:6379
      - MCP_SERVER_URL=http://django:8085/mcp
    depends_on:
      - redis
      - django
    restart: unless-stopped

  # ============ LLM AGENT (LangGraph) ============
  agent-llm:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
    container_name: neural-agent-llm
    ports:
      - "${AGENT_LLM_PORT:-8094}:8094"
    environment:
      - AGENT_NAME=llm
      - AGENT_PORT=8094
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-neural_interface}
      - MCP_SERVER_URL=http://django:8085/mcp
      - OLLAMA_BASE_URL=http://host.docker.internal:12434
      - OLLAMA_CHAT_MODEL=${OLLAMA_CHAT_MODEL:-deepseek-r1:7b}
      - OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LANGFUSE_HOST=http://langfuse:3000
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
      - django
      - postgres
      - langfuse
    restart: unless-stopped

  # ============ LANGFUSE (LLM Observability) ============
  langfuse:
    image: langfuse/langfuse:2
    container_name: neural-langfuse
    ports:
      - "${LANGFUSE_PORT:-8095}:3000"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-neural_admin}:${DB_PASSWORD}@postgres:5432/langfuse
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      - NEXTAUTH_URL=http://${HOST_IP:-172.168.1.95}:${LANGFUSE_PORT:-8095}
      - SALT=${LANGFUSE_SALT}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  recording_data:
